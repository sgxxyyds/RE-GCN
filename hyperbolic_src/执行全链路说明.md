# 双曲时序知识图谱补全模型执行全链路说明

本文档聚焦 **hyperbolic_src** 目录下的双曲时序知识图谱补全模型，梳理从数据加载、图构建、模型前向、训练与评估到输出产物的完整执行链路，并给出改进方向。

## 1. 入口与模块映射

| 角色 | 关键文件 | 说明 |
| --- | --- | --- |
| 训练/评估入口 | `hyperbolic_src/hyperbolic_main.py` | `run_experiment()` + `test()` 构成主链路 |
| 模型主体 | `hyperbolic_src/hyperbolic_model.py` | `HyperbolicRecurrentRGCN` |
| 双曲运算 | `hyperbolic_src/hyperbolic_ops.py` | `HyperbolicOps` + `TemporalRadiusEvolution` |
| 双曲 RGCN 层 | `hyperbolic_src/hyperbolic_layers.py` | `HyperbolicUnionRGCNLayer` |
| 双曲解码器 | `hyperbolic_src/hyperbolic_decoder.py` | `HyperbolicConvTransE/ConvTransR` |
| 图构建与评估 | `rgcn/utils.py` | `build_sub_graph()`、`get_total_rank()` |
| 数据加载 | `rgcn/utils.py` + `rgcn/knowledge_graph.py` | `load_data()` + `_read_triplets_as_list()` |

## 2. 数据与时间切片链路

1. **数据准备**（`data/<dataset>`）
   - `train.txt / valid.txt / test.txt`：四列格式 `(s, r, o, t)`。
   - （可选）`e-w-graph.txt`：静态图（实体-词）。

2. **加载与切片**（`rgcn/utils.py`）
   - `load_data(args.dataset)` 读入数据集（内部依赖 `rgcn/knowledge_graph.py`）。
   - `split_by_time(data.train/valid/test)` 将四列数据按时间戳切为快照列表。
   - `load_all_answers_for_time_filter()` 生成时间过滤的 ground truth 以支持 filtered 评估。

## 3. 时序图构建链路

`build_sub_graph(num_nodes, num_rels, triples, use_cuda, gpu)`（`rgcn/utils.py`）：

1. **补充反向边**：对每个 `(s, r, o)` 添加 `(o, r+num_rels, s)`。
2. **构建 DGLGraph**：生成节点、边、以及 `norm` 归一化因子。
3. **关系索引表**：
   - `g.uniq_r`：出现过的关系 ID
   - `g.r_to_e / g.r_len`：关系到实体的索引区间，用于关系上下文聚合

这些图将作为历史窗口输入模型前向。

## 4. 模型初始化链路

入口在 `hyperbolic_main.py`：

```python
model = HyperbolicRecurrentRGCN(
    decoder_name=args.decoder,
    encoder_name=args.encoder,
    num_ents=num_nodes,
    num_rels=num_rels,
    h_dim=args.n_hidden,
    sequence_len=args.train_history_len,
    c=args.curvature,
    ...
)
```

主要组件（`hyperbolic_model.py`）：

1. **实体/关系嵌入**
   - `dynamic_emb`：欧式初始化，映射至双曲空间。
   - `emb_rel`：关系嵌入（欧式切空间）。
2. **双曲 RE-GCN**
   - `HyperbolicRGCNCell` 复用 RE-GCN 聚合流程，内部使用 `HyperbolicUnionRGCNLayer`。
3. **时间门控（RE-GCN 风格）**
   - `time_gate_weight` / `time_gate_bias`，在切空间混合新旧状态。
4. **双曲时间半径演化**
   - `TemporalRadiusEvolution` 根据时间步调整语义半径（双曲创新点）。
5. **解码器**
   - `HyperbolicConvTransE`：实体预测。
   - `HyperbolicConvTransR`：关系预测。

## 5. 训练链路（run_experiment）

训练主循环在 `hyperbolic_main.py`：

1. **历史窗口构建**
   - 对每个时间步 `t`，取 `train_history_len` 个历史快照作为 `history_glist`。
2. **前向 + 损失**
   - `loss_e, loss_r, loss_static = model.get_loss(history_glist, output_triples, static_graph)`
   - 总损失：`task_weight * loss_e + (1 - task_weight) * loss_r + loss_static`
3. **反向与更新**
   - `loss.backward()` + `clip_grad_norm_` + `optimizer.step()`
4. **验证与早停**
   - `evaluate_every` 触发 `test(..., mode="train")`。
   - `best_mrr` 更新并保存至 `models/`。

## 6. 前向与预测链路（HyperbolicRecurrentRGCN.forward）

每个时间步的核心流程：

1. **关系上下文聚合**
   - 将实体表示映射到切空间 `log_map_zero`。
   - 按 `g.r_to_e` 聚合实体得到关系上下文。
2. **关系 GRU 更新**
   - `relation_gru` 更新关系嵌入。
3. **双曲 RGCN 传播**
   - `HyperbolicRGCNCell` 聚合邻居并映射回双曲空间。
4. **时间门控更新**
   - `time_weight = sigmoid(W * h_prev + b)`
   - 在切空间融合新旧表示。
5. **时间半径演化**
   - `TemporalRadiusEvolution` 调整实体半径（语义抽象程度）。

## 7. 评估链路（test）

`test()` 函数流程：

1. 构建历史图 `history_glist`（与训练同样方式）。
2. `model.predict()` 产出实体/关系评分矩阵。
3. `utils.get_total_rank()` 计算 raw/filter MRR 与 Hits@K。
4. 多步推理模式（`--multi-step`）通过 `construct_snap` 生成预测快照迭代输入。

## 8. 输出产物

| 类型 | 路径 | 内容 |
| --- | --- | --- |
| 模型权重 | `models/hyperbolic-*.pth` | `state_dict` + 最佳 epoch |
| 训练日志 | `hyperbolic_training_<dataset>.log` | 训练/验证指标 |
| 控制台指标 | stdout | MRR/Hits@K |

## 9. 可改进方向

1. **训练效率**
   - 缓存 `build_sub_graph` 生成的 DGLGraph，避免每个 epoch 重建。
   - 引入小批量时间步采样，缓解长序列带来的训练开销。
2. **模型表达**
   - 加入显式时间编码（time embedding），与半径演化协同。
   - 研究 per-relation 或 per-layer 曲率（目前为全局曲率）。
3. **稳定性**
   - 将 `TemporalRadiusEvolution` 的 attention 统计写入日志，辅助调参。
   - 提供更细粒度的数值保护（如自适应 clamp 范围）。
4. **评估一致性**
   - 增强 time-filtered 评估：对同一时间快照的真实三元组做局部过滤。
5. **工程化**
   - 增加配置文件入口（YAML/JSON）以便复现实验。
   - 增加脚本级数据校验（检查时间戳连续性与实体覆盖率）。

## 10. 快速执行指令（参考）

```bash
cd /home/runner/work/RE-GCN/RE-GCN/hyperbolic_src

# 训练
python hyperbolic_main.py -d ICEWS14s \
  --train-history-len 3 --test-history-len 3 \
  --n-layers 2 --n-hidden 200 \
  --self-loop --layer-norm \
  --entity-prediction --relation-prediction \
  --curvature 0.01 --gpu 0

# 测试
python hyperbolic_main.py -d ICEWS14s \
  --train-history-len 3 --test-history-len 3 \
  --n-layers 2 --n-hidden 200 \
  --self-loop --layer-norm \
  --entity-prediction --relation-prediction \
  --curvature 0.01 --gpu 0 --test
```
