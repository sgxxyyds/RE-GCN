# 双曲模型效果分析与优化方案

本文面向当前仓库的双曲时序 RE-GCN 实现（`hyperbolic_src`），针对 **MRR / Hits 低于 baseline RE-GCN** 的现象进行原因分析，并给出可落地的优化方向与详细技术方案，重点聚焦 **曲率应用不合理** 与 **双曲/欧式交互不一致** 等问题。

---

## 1. 效果不佳的关键原因分析

### 1.1 曲率与半径尺度不匹配
- 代码固定 `c=0.01`，而静态半径目标使用 `[0.5, 3.0]` 的欧式尺度（`_compute_radius_targets`），**半径范围与曲率半径上界未对齐**。
- `apply_radius()` 在每个时间步强制重设半径，导致 **方向信息保留但尺度被重投影**，可能造成过度收缩或语义漂移。
- 当 `c` 固定时，半径空间容量被限制，**大部分实体被挤压至相似半径区间**，层级结构难以展开。

### 1.2 超几何与切空间操作的“混用”导致信息损失
- 目前图卷积、时间门控在切空间进行，但 **全部使用原点 `log/exp`**，忽略局部切空间（local tangent space）特性。
- 时间门控的 `torch.clamp` 固定范围（`[-10,10]`）可能 **截断高曲率下的梯度**，抑制时间演化。
- 关系嵌入为欧式向量，解码在切空间进行，**超几何结构未被充分利用**。

### 1.3 半径监督与时间演化冲突
- 半径监督损失（`radius_lambda`）对 `radius_static` 施加强约束，但时间演化又依赖 `delta` 的微扰，**二者可能相互抵消**。
- 当前 `radius_target` 完全由静态统计导出，**未考虑时间维度变化**，导致动态事实在训练中被强行压回静态结构。

### 1.4 表达与优化的不匹配
- 当前使用欧式优化（Adam），缺少超几何优化（Riemannian SGD/Adam），**曲率较大时容易数值不稳定**。
- 超几何模型更依赖合适的初始化与数值保护；当前初始化是 RE-GCN 的欧式策略，**未针对超几何优化做校准**。

---

## 2. 优化方向总览（按优先级）

1. **曲率可学习 + 动态调度**
   - 学习全局或逐层曲率（`c_l`），并加入 **warm-up** 与范围约束。
2. **半径语义重构**
   - 半径监督改为 **时间感知+软约束**，或引入对数半径/分位数约束。
3. **局部切空间操作**
   - 将 `log/exp` 从固定原点迁移为局部中心（例如基于上一时刻中心或实体自身）。
4. **双曲解码与评分**
   - 引入 **超几何距离或 gyroplane** 评分，替换纯切空间解码。
5. **超几何优化器与数值稳定策略**
   - 采用 Riemannian Adam / 约束更新 + 投影机制，提升收敛稳定性。
6. **时间门控与演化改造**
   - 引入时间嵌入（Time Encoding），并让半径演化与时间门控协同。

---

## 3. 详细技术方案（分阶段落地）

### 阶段 A：诊断与稳定性增强（1-2 周）

**目标**：确认性能下降的关键触发点，提供可解释日志。

1. **诊断指标增强**
   - 在 `HyperbolicOps.log_embedding_stats()` 中增加：
     - radius 分位数（p10/p50/p90）
     - 实体半径与度数/频次相关性
   - 训练日志中记录：
     - curvature 值、半径均值/方差、`delta` 分布

2. **关闭双曲创新项做对照**
   - 对比以下三组：
     - 仅双曲空间（无半径演化）
     - 仅半径监督（无时间演化）
     - 当前完整模型

3. **数值稳定性微调**
   - 调整 `torch.clamp` 范围为可配置参数
   - 使用 `project_to_ball()` 的动态 `max_norm` 替代硬编码

**产出**：明确损失项、曲率、半径的影响方向，并验证性能瓶颈源头。

---

### 阶段 B：曲率重设计与半径语义优化（2-4 周）

**目标**：解决曲率与半径尺度不匹配的问题。

1. **曲率可学习 + 约束**
   - 将 `c` 扩展为：
     - 全局可学习（已有 `--learn-curvature`）
     - 可选逐层或逐关系曲率（新增 `--curvature-mode`）
   - 通过 `softplus` 或 `clamp` 保证稳定区间（如 `[1e-4, 1e-1]`）

2. **半径目标重构**
   - 将 `_compute_radius_targets` 改为：
     - 使用 **分位数归一**（避免极值支配）
     - 引入时间权重（近期快照加权）
   - 增加可选 `radius_schedule`：
     - 训练前期弱监督，后期增强

3. **半径监督松弛机制**
   - 将 `radius_lambda` 改为可调度（线性/余弦）
   - 或改为 **排名约束**（保持相对半径顺序而非绝对距离）

**产出**：稳定的半径分布 + 可解释的层级结构。

---

### 阶段 C：结构传播与解码改造（4-6 周）

**目标**：提升超几何表示在任务上的表达能力。

1. **局部切空间聚合**
   - 采用 `log_x`（以当前节点为中心）替代 `log_0`
   - 结合 “聚合后再平移回原点”的局部对齐策略

2. **超几何解码器**
   - 新增 `hyperbolic_distance` 或 gyroplane 解码器
   - 与现有切空间解码进行混合评分（`alpha` 加权）

3. **关系演化与时间嵌入**
   - 对 `relation_gru` 添加时间编码 `time_emb`
   - 半径演化使用 `(h, time_emb)` 的联合映射

**产出**：更强的结构传播 + 更符合双曲几何的评分函数。

---

### 阶段 D：训练策略与最终验证（6-8 周）

**目标**：从训练策略层面确保提升可复现。

1. **超几何优化器**
   - 引入 Riemannian Adam（可用 `geoopt`）
   - 对 `radius_static`、`dynamic_emb` 使用投影更新

2. **参数搜索与消融**
   - 曲率 `c`，半径范围，`radius_lambda`，`epsilon`
   - 对比 **RE-GCN baseline** 与 **不同曲率方案**

3. **评估策略校验**
   - 确认 filtered 评估与 baseline 一致
   - 增加多步推理下的 `Hits@1/3/10` 分析

**产出**：稳定超过 baseline 的 MRR / Hits 表现与完整消融报告。

---

## 4. 建议的代码改动清单（对应模块）

| 模块 | 建议改动 | 目的 |
| --- | --- | --- |
| `hyperbolic_ops.py` | 支持局部 log/exp、动态 clamp | 减少几何失真 |
| `hyperbolic_model.py` | 曲率策略、半径调度、时间嵌入 | 提升表达与稳定 |
| `hyperbolic_main.py` | 曲率/半径新参数、调度器 | 更好控制训练 |
| `hyperbolic_decoder.py` | 新增超几何距离评分 | 增强超几何优势 |

---

## 5. 验收标准（与 baseline 对齐）

- 在 ICEWS14s/ICEWS18 上：
  - **MRR 提升 ≥ 2%**
  - **Hits@10 不低于 baseline RE-GCN**
- 曲率、半径分布稳定（无爆炸/收缩）
- 消融结果可解释：曲率/半径模块带来明确增益

---

## 6. 实施优先级与里程碑

1. **P0（诊断 + 曲率/半径对齐）**：定位性能瓶颈，调整尺度
2. **P1（局部切空间 + 解码改造）**：提升超几何表达能力
3. **P2（优化器 + 调参）**：稳定性能并超越 baseline

---

如需落地实施，可按上述阶段逐步迭代，每个阶段确保与 RE-GCN baseline 进行严格对比与消融分析。
